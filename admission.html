<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Form - CODE</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Light blue-gray background */
        }
        .form-container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Shadow-lg */
            padding: 2.5rem; /* p-10 */
            width: 100%;
            max-width: 48rem; /* max-w-3xl */
        }
        .input-field {
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            padding: 0.625rem 1rem; /* px-4 py-2.5 */
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* focus:ring-blue-500 */
        }
        .submit-button {
            display: inline-flex;
            justify-content: center;
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border: none; /* border-transparent */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            color: #ffffff;
            background-color: #2563eb; /* bg-blue-700 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .submit-button:hover {
            background-color: #1d4ed8; /* hover:bg-blue-800 */
            transform: translateY(-1px);
        }
        .submit-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* focus:ring-blue-500 */
        }
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1.5rem;
        }
        .message-box.success {
            background-color: #d1fae5; /* bg-green-100 */
            color: #065f46; /* text-green-800 */
        }
        .message-box.error {
            background-color: #fee2e2; /* bg-red-100 */
            color: #991b1b; /* text-red-800 */
        }
        .section-title {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 1.5rem; /* mb-6 */
            text-align: center;
        }
        .receipt-container, .data-display-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 48rem;
        }
        .receipt-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .receipt-header h3 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800; /* font-extrabold */
            color: #1e40af; /* text-blue-800 */
        }
        .receipt-header p {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
            margin-top: 0.25rem;
        }
        .receipt-details div, .data-display-details div {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb; /* border-gray-200 */
        }
        .receipt-details div:last-child, .data-display-details div:last-child {
            border-bottom: none;
        }
        .receipt-details span:first-child, .data-display-details span:first-child {
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
        }
        .receipt-details span:last-child, .data-display-details span:last-child {
            color: #1f2937; /* text-gray-900 */
        }
        .print-button {
            background-color: #10b981; /* bg-emerald-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .print-button:hover {
            background-color: #059669; /* hover:bg-emerald-600 */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1rem;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div id="formContainer" class="form-container">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Admission Application Form</h2>

        <form id="admissionForm" class="space-y-6">
            <!-- Personal Information Section -->
            <div class="border-b border-gray-200 pb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Personal Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="fullName" name="fullName" required class="input-field">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required class="input-field">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="phone" name="phone" required class="input-field">
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                        <input type="date" id="dob" name="dob" required class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Full Address</label>
                        <textarea id="address" name="address" rows="3" required class="input-field"></textarea>
                    </div>
                </div>
            </div>

            <!-- Academic Information Section -->
            <div class="border-b border-gray-200 pb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Academic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="course" class="block text-sm font-medium text-gray-700 mb-1">Applying For Course</label>
                        <select id="course" name="course" required class="input-field">
                            <option value="">Select a course</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Business Administration">Business Administration</option>
                            <option value="Arts and Humanities">Arts and Humanities</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Data Science">Data Science</option>
                            <option value="Web Development">Web Development</option>
                            <option value="Graphic Design">Graphic Design</option>
                        </select>
                    </div>
                    <div>
                        <label for="previousSchool" class="block text-sm font-medium text-gray-700 mb-1">Previous School/College</label>
                        <input type="text" id="previousSchool" name="previousSchool" class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label for="academicAchievements" class="block text-sm font-medium text-gray-700 mb-1">Academic Achievements (Optional)</label>
                        <textarea id="academicAchievements" name="academicAchievements" rows="2" class="input-field"></textarea>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact Section -->
            <div class="border-b border-gray-200 pb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Emergency Contact</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="emergencyName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="emergencyName" name="emergencyName" required class="input-field">
                    </div>
                    <div>
                        <label for="emergencyPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="emergencyPhone" name="emergencyPhone" required class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label for="relationship" class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
                        <input type="text" id="relationship" name="relationship" required class="input-field">
                    </div>
                </div>
            </div>

            <!-- Declaration Section -->
            <div>
                <div class="flex items-center">
                    <input id="declaration" name="declaration" type="checkbox" required
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="declaration" class="ml-2 block text-sm text-gray-900">
                        I hereby declare that the information provided is true and accurate to the best of my knowledge.
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <button type="submit" class="submit-button">
                    Submit Application
                </button>
            </div>
        </form>

        <!-- Message Box for success/error -->
        <div id="messageBox" class="hidden message-box" role="alert">
            <p id="messageText"></p>
        </div>
    </div>

    <!-- Payment Receipt Section (hidden by default) -->
    <div id="paymentReceiptSection" class="receipt-container hidden printable-area no-print">
        <div class="receipt-header">
            <h3 class="text-blue-800">Computer & Digital Excellence - (CODE)</h3>
            <p>Lokenath Nagar, Bagdogra, 734014</p>
            <h4 class="text-2xl font-bold text-gray-800 mt-4">Payment Receipt</h4>
        </div>
        <div class="receipt-details text-gray-700 text-base space-y-2">
            <div>
                <span>Receipt No:</span>
                <span id="receiptNumber">CODE-REC-</span>
            </div>
            <div>
                <span>Date:</span>
                <span id="receiptDate"></span>
            </div>
            <div>
                <span>Applicant Name:</span>
                <span id="receiptApplicantName"></span>
            </div>
            <div>
                <span>Course Applied:</span>
                <span id="receiptCourse"></span>
            </div>
            <div>
                <span>Amount Paid:</span>
                <span>₹ 500.00 (Admission Fee)</span>
            </div>
            <div class="pt-4 border-t-2 border-dashed border-gray-300">
                <span class="font-bold text-lg">Payment Status:</span>
                <span class="font-bold text-lg text-green-600">SUCCESSFUL</span>
            </div>
        </div>
        <p class="text-center text-gray-600 text-sm mt-6">Thank you for your application!</p>
        <div class="flex justify-center mt-8 no-print">
            <button onclick="printReceipt()" class="print-button">Print Receipt</button>
        </div>
    </div>

    <!-- Admission Form Data Display Section (hidden by default) -->
    <div id="admissionDataSection" class="data-display-container hidden printable-area no-print">
        <h3 class="section-title">Submitted Admission Form Data</h3>
        <div id="admissionDataDetails" class="data-display-details text-gray-700 text-base space-y-2">
            <!-- Data will be populated here by JavaScript -->
        </div>
        <div class="flex justify-center mt-8 no-print">
            <button onclick="printAdmissionData()" class="print-button">Print Admission Data</button>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this with your Google Apps Script Web App URL
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwSqtlZaI312TgM5sbKhDPChcsNx_iZIyQVCyY1sSNnAw5kcvIDHA4fO_dPUoIT5SvO/exec';

        const form = document.getElementById('admissionForm');
        const formContainer = document.getElementById('formContainer');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const paymentReceiptSection = document.getElementById('paymentReceiptSection');
        const admissionDataSection = document.getElementById('admissionDataSection');

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            // Show loading indicator or disable button
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');

            messageBox.classList.add('hidden'); // Hide previous messages

            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                // Exponential backoff for API calls
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors', // Required for Google Apps Script web app
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams(data).toString(),
                        });

                        // For 'no-cors' mode, response.ok is always false, and response.status is 0.
                        // We rely on the Apps Script to process and assume success if no network error.
                        // A more robust solution would involve CORS setup on Apps Script and checking response.ok
                        // For simplicity and common Apps Script usage, we proceed assuming success.

                        showMessage('Your application has been submitted successfully!', 'success');
                        populateAndShowResults(data); // Populate and show the new sections
                        form.reset(); // Clear the form
                        break; // Exit retry loop on success

                    } catch (error) {
                        console.error('Error submitting form:', error);
                        retries++;
                        if (retries < maxRetries) {
                            const delay = baseDelay * Math.pow(2, retries - 1);
                            console.log(`Retrying in ${delay / 1000} seconds... (Attempt ${retries}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            showMessage('Failed to submit application. Please try again later.', 'error');
                        }
                    }
                }

            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Application';
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        function showMessage(message, type) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') {
                messageBox.classList.add('success');
            } else if (type === 'error') {
                messageBox.classList.add('error');
            }
            messageBox.classList.remove('hidden');
        }

        function populateAndShowResults(formData) {
            // Hide the form and message box
            formContainer.classList.add('hidden');
            messageBox.classList.add('hidden');

            // Populate Payment Receipt
            const now = new Date();
            document.getElementById('receiptNumber').textContent = `CODE-REC-${now.getTime().toString().slice(-6)}`;
            document.getElementById('receiptDate').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('receiptApplicantName').textContent = formData.fullName;
            document.getElementById('receiptCourse').textContent = formData.course;
            paymentReceiptSection.classList.remove('hidden');

            // Populate Admission Data Display
            const admissionDataDetails = document.getElementById('admissionDataDetails');
            admissionDataDetails.innerHTML = ''; // Clear previous data

            const displayFields = {
                'Full Name': formData.fullName,
                'Email Address': formData.email,
                'Phone Number': formData.phone,
                'Date of Birth': formData.dob,
                'Full Address': formData.address,
                'Applying For Course': formData.course,
                'Previous School/College': formData.previousSchool || 'N/A',
                'Academic Achievements': formData.academicAchievements || 'N/A',
                'Emergency Contact Name': formData.emergencyName,
                'Emergency Contact Phone': formData.emergencyPhone,
                'Relationship': formData.relationship,
                'Declaration Accepted': formData.declaration ? 'Yes' : 'No'
            };

            for (const label in displayFields) {
                const div = document.createElement('div');
                div.innerHTML = `<span>${label}:</span><span>${displayFields[label]}</span>`;
                admissionDataDetails.appendChild(div);
            }
            admissionDataSection.classList.remove('hidden');
        }

        function printReceipt() {
            window.print();
        }

        function printAdmissionData() {
            window.print();
        }
    </script>
</body>
</html>
